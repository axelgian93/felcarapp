name: taxiappFelcar

services:
  app:
    container_name: felcarapp
    build:
      context: ..
      dockerfile: Dockerfile
      target: fe-serve
      args:
        API_KEY: ${API_KEY}
        VITE_FIREBASE_API_KEY: ${VITE_FIREBASE_API_KEY}
        VITE_FIREBASE_AUTH_DOMAIN: ${VITE_FIREBASE_AUTH_DOMAIN}
        VITE_FIREBASE_PROJECT_ID: ${VITE_FIREBASE_PROJECT_ID}
        VITE_FIREBASE_STORAGE_BUCKET: ${VITE_FIREBASE_STORAGE_BUCKET}
        VITE_FIREBASE_MESSAGING_SENDER_ID: ${VITE_FIREBASE_MESSAGING_SENDER_ID}
        VITE_FIREBASE_APP_ID: ${VITE_FIREBASE_APP_ID}
        VITE_FIREBASE_MEASUREMENT_ID: ${VITE_FIREBASE_MEASUREMENT_ID}
        VITE_GEMINI_API_KEY: ${VITE_GEMINI_API_KEY}
        VITE_GEMINI_PROXY_URL: ${VITE_GEMINI_PROXY_URL}
        VITE_OSRM_URL: ${VITE_OSRM_URL:-http://localhost:5000}
        VITE_ETA_URL: ${VITE_ETA_URL:-http://localhost:8788}
    ports:
      - "80:80"
    restart: always
    env_file:
      - ../.env
  eta:
    build:
      context: ..
      dockerfile: Dockerfile
      target: eta-serve
    environment:
      - OSRM_URL=${OSRM_URL:-http://osrm-a:5000}
      - PORT=8788
      - LOG_FILE=/var/log/eta/eta.log
    ports:
      - "8788:8788"
    volumes:
      - ./logs/eta:/var/log/eta
    depends_on:
      - osrm-a
      - osrm-b
      - osrm-lb
    restart: unless-stopped

  proxy:
    build:
      context: ..
      dockerfile: Dockerfile
      target: proxy-serve
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - PORT=8787
      - LOG_LEVEL=info
    ports:
      - "8787:8787"
    restart: unless-stopped
  osrm-a:
    image: osrm/osrm-backend:latest
    command: >
      bash -c "
        osrm-extract -p /opt/car.lua /data/ecuador-latest.osm.pbf &&
        osrm-partition /data/ecuador-latest.osrm &&
        osrm-customize /data/ecuador-latest.osrm &&
        osrm-routed --algorithm mld --max-table-size 8000 /data/ecuador-latest.osrm
      "
    volumes:
      - ./osrm-data:/data
    ports:
      - "5001:5000"
    restart: unless-stopped

  osrm-b:
    image: osrm/osrm-backend:latest
    command: >
      bash -c "
        osrm-extract -p /opt/car.lua /data/ecuador-latest.osm.pbf &&
        osrm-partition /data/ecuador-latest.osrm &&
        osrm-customize /data/ecuador-latest.osrm &&
        osrm-routed --algorithm mld --max-table-size 8000 /data/ecuador-latest.osrm
      "
    volumes:
      - ./osrm-data:/data
    ports:
      - "5002:5000"
    restart: unless-stopped

  osrm-lb:
    image: nginx:1.25-alpine
    volumes:
      - ./osrm-lb/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "5000:5000"
    depends_on:
      - osrm-a
      - osrm-b
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
    ports:
      - "9090:9090"
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=felcar123
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    restart: unless-stopped
